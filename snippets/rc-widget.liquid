<style>
  .purchase-option-container {
    background-color: transparent;
    border-radius: 10px;
    border: 1px solid #000000;
    padding: 0 12px;
  }

  .purchase-option-container.active--true {
    background-color: #FFFFFF;
  }


  .purchase-option-header {
    padding: 12px 0;
    display: flex;
    justify-content: space-between;
  }


  .purchase-option {
    border-top: 1px solid #000000;
    padding: 12px 0;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .purchase-option-price {
    display: flex;
    column-gap: 6px;
    align-items: center;
  }

  .purchase-option input {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    z-index: 1;
    opacity: 0;
    margin: 0;
    cursor: pointer;
  }

  .purchase-option label {
    padding-left: calc(18px + 6px);
    margin-right: 6px;
    position: relative;
  }

  .purchase-option label:before,
  .purchase-option label:after {
    content: " ";
    display: inline-block;
    border-radius: 100%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0;
  }

  .purchase-option label:before {
    width: 18px;
    height: 18px;
    border: 1px solid #000000;
  }

  .purchase-option label:after {
    width: 12px;
    height: 12px;
    border-radius: 100%;
    left: 3px;
    background-color: #FFFFFF;
    transition: background-color 150ms ease;
  }

  .purchase-option input:checked + label:after {
    background-color: #000000;
  }


  .purchase-option-badge {
    border: 1px solid #000000;
    border-radius: 10px;
    background-color: #FCF7F0;
    padding: 3px 10px;
    padding-top: 4px;
  }

  .purchase-option-savings {
    border-radius: 10px;
    background-color: #FFE5E0;
    color: #F51E28;
    padding: 3px 10px;
    padding-top: 4px;
  }


  .option-price {
    font-weight: 700;
  }

  .option-sale-price {
    font-weight: 700;
    color: red;
  }

  .option-compare-price {
    font-weight: 700;
    text-decoration: line-through;
  }


  .option-description {
    margin: 6px 0;
  }


  .option-incentives {
    margin: 0;
    padding: 0;
    list-style-type: none;
    padding-bottom: 12px;
  }

  .option-incentive {
    position: relative;
    padding: 5px;
    padding-left: 20px;
  }

  .option-incentive:before {
    content: '';
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14' fill='none'%3E%3Cpath d='M12.75 1.24951L4.5 12.7495L1.25 9.49951' stroke='black' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    width: 14px;
    height: 14px;
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
  }
</style>

<style>
  .component-dropdown {
    display: block;
    cursor: pointer;
  }

  .component-dropdown > div:last-child {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 300ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .component-dropdown > div:last-child > div {
    overflow: hidden;
  }

  .component-dropdown.active--true > div:last-child {
    grid-template-rows: 1fr;
  }

  .component-radio-dropdown:has(input:checked) > div:last-child {
    grid-template-rows: 1fr;
  }
</style>

<style>
  component-variant-subscriptions,
  component-one-time-variants {
    display: block;
  }
</style>

{%- liquid
  assign show_subscription = true

  if product.selected_variant and product.selected_selling_plan == nil
    assign show_subscription = false
  endif


  assign show_one_time = false

  unless show_subscription
    assign show_one_time = true
  endunless
-%}

<component-variant-subscriptions data-section="{{ section.id }}" data-url="{{ product.url }}">
  <component-purchase-dropdown class="component-dropdown purchase-option-container active--{{ show_subscription }}">
    <div class="purchase-option-header">
      <strong>Subscribe & Save!</strong>
    </div>
    <div>
      <div>
        {%- for variant in product.variants -%}
          {%- liquid
            assign variant_allocation = variant.selected_selling_plan_allocation

            unless variant_allocation
              for allocation in variant.selling_plan_allocations
                assign supply_number = variant.title | split: " " | first

                if allocation.selling_plan.name contains supply_number
                  assign variant_allocation = allocation
                  break
                endif
              endfor
            endunless

            assign selling_plan_id = variant_allocation.selling_plan.id

            assign description = variant.title | append: " " | append: variant_allocation.selling_plan.name
            assign description = description | replace: "Delivery", "delivered"


            assign checked = nil

            if variant.id == current_variant.id or forloop.first
              assign checked = "checked"
            endif


            assign number_of_units = variant.title | split: " " | first | times: 1
          -%}

          <div class="component-dropdown component-radio-dropdown">
            <div class="purchase-option">
              <div>
                <input name="subscription_variant" type="radio" value="{{ selling_plan_id }}" {{ checked }} data-variant-id="{{ variant.id }}" />

                <label>
                  {{ variant.title }} Supply
                </label>

                {%- if forloop.index == 2 -%}
                  <span class="purchase-option-badge">Most Popular!</span>
                {%- endif -%}

                {%- if forloop.last -%}
                  <span class="purchase-option-badge">Best Value!</span>
                {%- endif -%}
              </div>

              <div class="purchase-option-price">
                <div style="display: flex; flex-direction: column; text-align: center;">
                  <span>
                    {%- if variant_allocation.compare_at_price > variant_allocation.price -%}
                      <span class="option-sale-price">
                        {{ variant_allocation.price | divided_by: number_of_units | money }}
                      </span>
                      <span class="option-compare-price">
                        {{ variant_allocation.compare_at_price | divided_by: number_of_units | money }}
                      </span>
                    {%- else -%}
                      <span class="option-price">
                        {{ variant_allocation.price | divided_by: number_of_units | money }}
                      </span>
                    {%- endif -%}
                  </span>

                  <span style="font-size: 11px;">per pack</span>
                </div>

                <div>
                  <span class="purchase-option-savings">
                    save {% cycle "15%", "20%", "25%" %}
                  </span>
                </div>
              </div>
            </div>
            <div>
              <div>
                <p class="option-description">
                  <strong>{{ description }}</strong>
                </p>
                <ul class="option-incentives">
                  <li class="option-incentive">{% cycle "15%", "20%", "25%" %} off for life</li>
                  <li class="option-incentive">Pause, modify, or cancel anytime</li>
                  <li class="option-incentive">Free US shipping on every order over $50</li>
                </ul>
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </component-purchase-dropdown>
</component-variant-subscriptions>

<component-one-time-variants data-section="{{ section.id }}" data-url="{{ product.url }}">
  <component-purchase-dropdown class="component-dropdown purchase-option-container active--{{ show_one_time }}">
    <div class="purchase-option-header">
      <strong>One-time Purchase</strong>
    </div>
    <div>
      <div>
        {%- for variant in product.variants -%}
          {%- liquid
            assign checked = nil

            if variant.id == current_variant.id or forloop.first
              assign checked = "checked"
            endif


            assign variant_on_sale = false

            if variant.compare_at_price > variant.price
              assign variant_on_sale = true
            endif


            assign discount_percentage = nil

            if variant_on_sale
              assign discount_percentage = variant.compare_at_price | minus: variant.price | times: 100.0
              assign discount_percentage = discount_percentage | divided_by: variant.compare_at_price | round
              assign discount_percentage = discount_percentage | append: "%"
            endif


            assign number_of_units = variant.title | split: " " | first | times: 1
          -%}

          <div class="purchase-option">
            <div>
              <input name="one" type="radio" value="{{ variant.id }}" {{ checked }} />

              <label>
                {{ variant.title }} Supply
              </label>
            </div>
            <div class="purchase-option-price">
              <div style="display: flex; flex-direction: column; text-align: center;">
                <span>
                  {%- if variant.compare_at_price > variant.price -%}
                    <span class="option-sale-price">
                      {{ variant.price | divided_by: number_of_units | money }}
                    </span>
                    <span class="option-compare-price">
                      {{ variant.compare_at_price | divided_by: number_of_units | money }}
                    </span>
                  {%- else -%}
                    <span class="option-price">
                      {{ variant.price | divided_by: number_of_units | money }}
                    </span>
                  {%- endif -%}
                </span>

                <span style="font-size: 11px;">per pack</span>
              </div>

              {%- if discount_percentage -%}
                <div>
                  <span class="purchase-option-savings">
                    Save {{ discount_percentage }}
                  </span>
                </div>
              {%- endif -%}
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </component-purchase-dropdown>
</component-one-time-variants>

<script>
  class ComponentPurchaseDropdown extends HTMLElement {
    constructor() {
      super();
    }

    connectedCallback() {
      this.events();
    }

    events() {
      if (this.classList.contains("active--true")) {
        this.triggerChange();
      }

      this.addEventListener("click", (event) => {
        if (this.classList.contains("active--true")) {
          return;
        } else {
          this.triggerChange();
          this.hideGroup();
          this.classList.add("active--true");
        }
      });
    }

    triggerChange() {
      const element = this.querySelector("input[type=radio]:checked");
      element.dispatchEvent(new Event("change", { bubbles: true }));
    }

    hideGroup() {
      const dropdowns = document.querySelectorAll("component-purchase-dropdown");

      dropdowns.forEach((element) => {
        element.classList.remove("active--true");
      });
    }
  }

  customElements.define("component-purchase-dropdown", ComponentPurchaseDropdown);
</script>
